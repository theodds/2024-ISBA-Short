---
title: "MEPS"
author: "Antonio Linero"
date: "2024-05-20"
output: html_document
---

This document illustrates the use of a Bayesian causal forest to estimate the
causal effect of smoking on self-rated health (SRH) using data from the medical
expenditure panel survey (MEPS). We begin by loading the data.

```{r load, message=FALSE}
library(tidyverse)
library(SoftBart)

meps <- readRDS("../Data/meps2011.rds")
```

# Model Description

We use a model of the form

$$
  Y_i = m(X_i) + \{A_i - \widehat e(X_i)\} \, \tau(X_i) + \epsilon_i
$$

where $\epsilon_i \sim \text{Normal}(0, \sigma^2)$, $A_i$ is the indicator for
smoking, and $\widehat e(X_i)$ is an estimate of the propensity score. The
treatment effect function is given by $\tau(x)$, and we consider a regression on
the residual $A_i - \widehat e(X_i)$ to address regularization induced
confounding. If $\widehat e(X_i) \approx e(X_i)$ then $m(X_i)$ can be
interpreted as the marginal mean

$$
  m(x) \approx \mathbb E(Y_i \mid X_i = x)
$$

which is immediate from the fact that
$\mathbb E(A_i \mid X_i = x) \approx \widehat e(x)$. Both $m(x)$ and $\tau(x)$
are modeled with soft BART models, as is the propensity score:

$$
  e(x) = \Phi\left\{f(x)\right\}
$$

with $f(x)$ modeled using a BART model.

# Some Causal Questions

We are interested in answering the following high-level questions:

1.  Are there any sub-populations for which the effect of smoking on health
    seems to be larger (smaller) than the overall effect? In particular, how
    does this relate to age, socio-economic status, and race?
2.  What is the overall (average) effect of smoking on self-rated health?

# Getting the Clever Covariate

Because the following code takes a long time to run, I have it set up to cache
the results of the computation so that it only needs to be run once.

```{r clever}
if(file.exists("../cache/fitted_smoke.rds")) {
  fitted_smoke <- readRDS("../cache/fitted_smoke.rds")
} else {
  set.seed(120398)
  fitted_smoke <- softbart_probit(factor(smoke) ~ age + bmi + edu + income + povlev + 
                                    region + sex + marital + race + seatbelt, 
                                  test_data = meps,
                                  data = meps)  
  saveRDS(fitted_smoke, "../cache/fitted_smoke.rds")
}
```

After fitting the model, we save the residual to the variable `smoke_res` in the
MEPS dataset:

```{r robbins}
meps <- mutate(meps, smoke_res = smoke - fitted_smoke$p_train_mean)
```

# Fitting the BCF

Next, we fit the Bayesian causal forest. We once again cache the result to avoid
repeating computations on re-runs.

```{r}
if(file.exists("../cache/fitted_bcf.rds")) {
  fitted_bcf <- readRDS("../cache/fitted_bcf.rds")
} else {
  set.seed(20948)
  fitted_bcf <- vc_softbart_regression(phealth ~ age + bmi + edu + income + 
                                         povlev + region + sex + marital + race + 
                                         seatbelt, linear_var_name = "smoke_res",
                                       data = meps, test_data = meps)
  saveRDS(fitted_bcf, "../cache/fitted_bcf.rds")
}
```

# The Overall Effect

The overall effect of smoking can be assessed by computing the *average
treatment effect*

$$
  \bar \tau = \mathbb E\{Y_i(1) - Y_i(0)\} = \int \tau(x) \, f_X(x) \ dx
$$

where $f_X(x)$ is the density of the covariates. To avoid specifying a
parametric family for $f_X(x)$ we instead take it to be (a) discrete and (b)
supported at each of the observed covariate values so that $f_X(x) = \omega_x$
and

$$
  \bar \tau = \sum_{i = 1}^N \omega_{X_i} \, \tau(X_i).
$$

We then model the $\omega_x$'s using the *Bayesian bootstrap* so that the
posterior distribution of the weights is given by

$$
  (\omega_{X_1}, \ldots, \omega_{X_N}) \sim \text{Dirichlet}(1, \ldots, 1).
$$

# Subgroup Discovery

# The Effect of Age

```{r}
head(meps)
```
